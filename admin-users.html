<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users Management - Admin - CameraRental</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“·</text></svg>">
  <link rel="stylesheet" href="light-theme.css">
</head>
<body>
  <nav class="topbar">
    <div class="nav-container">
      <a href="dashboard.html" class="logo">
        <span class="logo-mark" aria-hidden="true">ðŸ“·</span>
        <span class="logo-text">CameraRental</span>
      </a>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item nav-admin"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li class="nav-item nav-admin"><a href="admin-rentals.html" class="nav-link">Rentals</a></li>
        <li class="nav-item nav-admin"><a href="admin-cameras.html" class="nav-link">Cameras</a></li>
        <li class="nav-item nav-admin"><a href="admin-users.html" class="nav-link active">Users</a></li>
        <li class="nav-item"><a href="profile.html" class="nav-link">Profile</a></li>
        <li class="nav-item"><a href="#" id="logoutBtn" class="nav-link nav-logout">Logout</a></li>
      </ul>
      <div class="hamburger" id="hamburger" aria-label="Menu" role="button" tabindex="0">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <div class="hero-inner container">
      <div class="hero-left">
        <p class="badge">User Administration</p>
        <h1 class="page-title">Users Management</h1>
        <p class="hero-subtitle">
          Manage user accounts, roles, and permissions across the platform.
        </p>
      </div>
      <div class="hero-right" aria-hidden="true">
        <div class="camera-card">
          <div class="camera-top"></div>
          <div class="camera-body">
            <div class="camera-lens">
              <div class="lens-ring"></div>
              <div class="lens-glow"></div>
            </div>
            <div class="camera-flash"></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <div></div>
        <button class="btn btn-primary" onclick="showAddUserModal()">+ Add User</button>
      </div>
      
      <div class="table-container">
        <table id="usersTable">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Username</th>
              <th>Full Name</th>
              <th>Role</th>
              <th>
                <span style="cursor: pointer;" onclick="sortByStatus()" title="Click to sort by status">
                  Status 
                  <span id="statusSortIcon">â‡…</span>
                </span>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" style="text-align: center;">Loading users...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Add/Edit User Modal -->
  <div id="userModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h2 id="modalTitle">Add User</h2>
      <form id="userForm">
        <div class="form-group">
          <label>First Name *</label>
          <input type="text" name="firstname" required>
        </div>
        <div class="form-group">
          <label>Last Name *</label>
          <input type="text" name="lastname" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" name="email" required id="userEmail">
        </div>
        <div class="form-group">
          <label>Username *</label>
          <input type="text" name="username" required>
        </div>
        <div class="form-group">
          <label>Password *</label>
          <input type="password" name="password" required id="userPassword">
        </div>
        <div class="form-group">
          <label>Role *</label>
          <select name="role" required>
            <option value="renter">Renter</option>
            <option value="employee">Employee</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" name="is_active" id="userIsActive" style="width: auto;">
            <span>Active Account</span>
          </label>
          <p style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">
            Inactive users cannot log in to the system.
          </p>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 8px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
          <button type="button" class="btn" onclick="closeUserModal()" style="flex: 1;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- jQuery CDN -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/auth.js"></script>
  <script src="js/users.js"></script>
  <script src="js/main.js"></script>
  <script>
    requireAuth();
    
    // Role-based navigation visibility
    function showRole(roleName) {
      const $body = $('body');
      $body.removeClass('role-admin role-employee role-renter');
      $body.addClass('role-' + roleName);

      $('.role-admin, .role-employee, .role-renter, .nav-admin, .nav-employee, .nav-renter').hide();
      $('.role-' + roleName + ', .nav-' + roleName).show();
    }
    
    // Check and refresh role
    async function checkRole() {
      let role = localStorage.getItem('userRole');
      
      // Refresh role from server
      if (typeof refreshUserRole === 'function') {
        const refreshedRole = await refreshUserRole();
        if (refreshedRole) {
          role = refreshedRole;
        }
      }
      
      if (role !== 'admin') {
        Swal.fire({
          icon: 'error',
          title: 'Access Denied',
          text: 'Admin role required.',
          confirmButtonText: 'Go to Login'
        }).then(() => {
          window.location.href = 'login.html';
        });
        return false;
      }
      
      // Apply role-based UI
      showRole('admin');
      return true;
    }
    
    // Check role and proceed
    checkRole().then(hasAccess => {
      if (!hasAccess) return;
      // Continue with page initialization
      loadUsersList();
    });

    let editingUserId = null;

    async function loadUsersList() {
      try {
        const users = await loadUsers();
        const $tbody = $('#usersTable tbody');
        
        if (users.length === 0) {
          $tbody.html('<tr><td colspan="6" style="text-align: center;">No users found.</td></tr>');
          return;
        }

        $tbody.empty();
        $.each(users, function(index, user) {
          const statusClass = user.is_active ? 'status-active' : 'status-inactive';
          const statusText = user.status || (user.is_active ? 'Active' : 'Inactive');
          const $tr = $('<tr>').html(`
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.full_name}</td>
            <td><span class="status-badge">${user.role}</span></td>
            <td>
              <span class="status-badge ${statusClass}" data-status="${user.is_active}">${statusText}</span>
            </td>
            <td>
              <button class="btn btn-primary edit-user-btn" data-id="${user.id}">Edit</button>
              <button class="btn ${user.is_active ? 'btn-warning' : 'btn-success'} toggle-status-btn" 
                      data-id="${user.id}" 
                      data-active="${user.is_active}"
                      title="${user.is_active ? 'Deactivate' : 'Activate'}">
                ${user.is_active ? 'Deactivate' : 'Activate'}
              </button>
              <button class="btn btn-danger delete-user-btn" data-id="${user.id}">Delete</button>
            </td>
          `);
          $tbody.append($tr);
        });
      } catch (err) {
        console.error('Error loading users:', err);
        $('#usersTable tbody').html('<tr><td colspan="6" style="text-align: center; color: red;">Error loading users. Please try again.</td></tr>');
      }
    }
    
    let statusSortOrder = 'desc'; // 'desc' = Active first, 'asc' = Inactive first
    
    function sortByStatus() {
      statusSortOrder = statusSortOrder === 'desc' ? 'asc' : 'desc';
      const icon = statusSortOrder === 'desc' ? 'â†“' : 'â†‘';
      $('#statusSortIcon').text(icon);
      loadUsersList();
    }
    
    async function toggleUserStatus(id, currentStatus) {
      const newStatus = !currentStatus;
      const action = newStatus ? 'activate' : 'deactivate';
      
      const result = await Swal.fire({
        icon: 'question',
        title: `${action.charAt(0).toUpperCase() + action.slice(1)} User?`,
        text: `Are you sure you want to ${action} this user?`,
        showCancelButton: true,
        confirmButtonText: `Yes, ${action}`,
        cancelButtonText: 'Cancel',
        confirmButtonColor: newStatus ? '#16a34a' : '#f59e0b'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        await updateUser(id, { is_active: newStatus });
        await Swal.fire({
          icon: 'success',
          title: 'Updated!',
          text: `User ${action}d successfully!`,
          timer: 2000,
          showConfirmButton: false
        });
        loadUsersList();
      } catch (err) {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.response?.data?.message || err.message || `Error ${action}ing user`
        });
      }
    }

    function showAddUserModal() {
      editingUserId = null;
      $('#modalTitle').text('Add User');
      $('#userForm')[0].reset();
      $('#userEmail').prop('disabled', false);
      $('#userPassword').prop('required', true);
      $('#userIsActive').prop('checked', true); // New users are active by default
      $('#userModal').css('display', 'flex');
    }

    function closeUserModal() {
      $('#userModal').hide();
      editingUserId = null;
      $('#userForm')[0].reset();
    }

    async function editUser(id) {
      try {
        const response = await authAxios({
          method: 'GET',
          url: `https://prolens.ccs4thyear.com/api/users/${id}`
        });
        const user = response.data;

        editingUserId = id;
        $('#modalTitle').text('Edit User');
        $('input[name="firstname"]').val(user.firstname);
        $('input[name="lastname"]').val(user.lastname);
        $('input[name="username"]').val(user.username);
        $('#userEmail').val(user.email).prop('disabled', true);
        $('#userPassword').prop('required', false);
        $('select[name="role"]').val(user.role).prop('disabled', false);
        $('#userIsActive').prop('checked', user.is_active !== false); // Default to true if not set
        $('#userModal').css('display', 'flex');
      } catch (err) {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error loading user: ' + err.message
        });
      }
    }

    async function handleDeleteUser(id) {
      const result = await Swal.fire({
        icon: 'warning',
        title: 'Delete User?',
        text: 'Are you sure you want to delete this user? This action cannot be undone.',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#ef4444'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        await deleteUser(id);
        await Swal.fire({
          icon: 'success',
          title: 'Deleted!',
          text: 'User deleted successfully!',
          timer: 2000,
          showConfirmButton: false
        });
        loadUsersList();
      } catch (err) {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.response?.data?.message || err.message || 'Error deleting user'
        });
      }
    }

    // jQuery event handlers
    $(function() {
      // Delegated events for dynamic content
      $('#usersTable').on('click', '.edit-user-btn', function() {
        editUser($(this).data('id'));
      });
      
      $('#usersTable').on('click', '.delete-user-btn', function() {
        handleDeleteUser($(this).data('id'));
      });
      
      $('#usersTable').on('click', '.toggle-status-btn', function() {
        const id = $(this).data('id');
        const currentStatus = $(this).data('active') === true || $(this).data('active') === 'true';
        toggleUserStatus(id, currentStatus);
      });

      // Hamburger menu
      $('#hamburger').on('click', function() {
        $(this).toggleClass('active');
        $('#nav-menu').toggleClass('active');
      });
    });

    $('#userForm').on('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      const userData = {};

      if (!editingUserId) {
        // Creating new user - all fields required
        userData.firstname = formData.get('firstname');
        userData.lastname = formData.get('lastname');
        userData.username = formData.get('username');
        userData.email = formData.get('email');
        userData.role = formData.get('role');
        userData.password = formData.get('password');
        userData.is_active = formData.get('is_active') === 'on';
      } else {
        // Updating existing user - only send fields that are provided and not empty
        const firstname = formData.get('firstname')?.trim();
        const lastname = formData.get('lastname')?.trim();
        const username = formData.get('username')?.trim();
        const password = formData.get('password');
        const role = formData.get('role');
        const isActive = formData.get('is_active') === 'on';
        
        // Only include fields that have values
        // Username and password are optional when editing - if not provided, they remain unchanged
        if (firstname) userData.firstname = firstname;
        if (lastname) userData.lastname = lastname;
        if (username) userData.username = username;
        // Password is only sent if a new one is provided (leave empty to keep current password)
        if (password && password.trim() !== '') {
          userData.password = password;
        }
        // Role is always sent when editing (required field)
        if (role) userData.role = role;
        // Status is always sent when editing
        userData.is_active = isActive;
      }
      
      try {
        if (editingUserId) {
          const oldUserData = JSON.parse(localStorage.getItem('userInfo') || '{}');
          const isUpdatingSelf = oldUserData.id === editingUserId;
          const oldRole = oldUserData.role;
          
          await updateUser(editingUserId, userData);
          await Swal.fire({
            icon: 'success',
            title: 'Updated!',
            text: 'User updated successfully!',
            timer: 2000,
            showConfirmButton: false
          });
          
          // If updating own role, refresh and redirect
          if (isUpdatingSelf && userData.role && userData.role !== oldRole) {
            // Refresh user role from server
            if (typeof refreshUserRole === 'function') {
              await refreshUserRole();
            }
            await Swal.fire({
              icon: 'info',
              title: 'Role Changed',
              html: `Your role has been changed. The page will refresh to apply the changes.`,
              confirmButtonText: 'OK',
              allowOutsideClick: false
            });
            window.location.href = 'dashboard.html';
            return;
          }
          
          // If updating another user's role, notify them via localStorage event
          if (userData.role) {
            // Trigger role change notification for other tabs/windows
            localStorage.setItem('roleChanged', JSON.stringify({
              userId: editingUserId,
              oldRole: oldRole,
              newRole: userData.role,
              timestamp: Date.now()
            }));
            localStorage.removeItem('roleChanged');
          }
        } else {
          await addUser(userData);
          await Swal.fire({
            icon: 'success',
            title: 'Added!',
            text: 'User added successfully!',
            timer: 2000,
            showConfirmButton: false
          });
        }
        closeUserModal();
        loadUsersList();
      } catch (err) {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.response?.data?.message || err.message || 'Error saving user'
        });
      }
    });

    window.showAddUserModal = showAddUserModal;
    window.closeUserModal = closeUserModal;
    window.editUser = editUser;
    window.handleDeleteUser = handleDeleteUser;
  </script>
</body>
</html>

