<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rent a Book - Client - CameraRental</title>
  <link rel="stylesheet" href="dashboard-styles.css">
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="dashboard.html" class="logo">CameraRental</a>
      <ul class="nav-menu" id="nav-menu">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="client-rent-book.html" class="nav-link active">Rent Book</a></li>
        <li><a href="client-my-rentals.html" class="nav-link">My Rentals</a></li>
        <li><a href="profile.html" class="nav-link">Profile</a></li>
        <li><a href="#" id="logoutBtn" class="nav-link">Logout</a></li>
      </ul>
      <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <main>
    <div class="container">
      <h1>Rent a Book</h1>
      
      <div class="form-container">
        <form id="rentBookForm">
          <div class="form-group">
            <label>Select Book *</label>
            <select name="book_id" id="bookSelect" required>
              <option value="">Loading books...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Select Librarian (optional)</label>
            <select name="librarian_id" id="librarianSelect">
              <option value="">Any available librarian</option>
            </select>
          </div>
          <div class="form-group">
            <label>Rental Duration (days) *</label>
            <input type="number" name="rental_duration" min="1" required>
          </div>
          <div class="form-group">
            <label>Rental Date *</label>
            <input type="date" name="rental_date" required id="rentalDate">
          </div>
          <div class="form-group">
            <label>Return Date (auto-calculated)</label>
            <input type="date" name="return_date" id="returnDate" readonly style="background: var(--secondary-bg);">
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Rental Request</button>
        </form>
      </div>
    </div>
  </main>

  <!-- jQuery CDN -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/auth.js"></script>
  <script src="js/books.js"></script>
  <script src="js/rentals.js"></script>
  <script src="js/main.js"></script>
  <script>
    requireAuth();
    
    const role = localStorage.getItem('userRole');
    if (role !== 'client') {
      alert('Access denied. Client role required.');
      window.location.href = 'login.html';
    }

    // Set minimum date to tomorrow (cannot rent starting today)
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    document.getElementById('rentalDate').setAttribute('min', tomorrowStr);

    // Calculate return date
    document.getElementById('rentalDate').addEventListener('change', calculateReturnDate);
    document.querySelector('input[name="rental_duration"]').addEventListener('input', calculateReturnDate);

    function calculateReturnDate() {
      const rentalDate = document.getElementById('rentalDate').value;
      const duration = parseInt(document.querySelector('input[name="rental_duration"]').value) || 0;
      
      if (rentalDate && duration > 0) {
        const date = new Date(rentalDate);
        date.setDate(date.getDate() + duration);
        document.getElementById('returnDate').value = date.toISOString().split('T')[0];
      }
    }

    async function loadAvailableBooks() {
      try {
        const books = await loadBooks();
        const availableBooks = books.filter(book => book.is_available);
        const select = document.getElementById('bookSelect');
        
        if (availableBooks.length === 0) {
          select.innerHTML = '<option value="">No available books</option>';
          return;
        }

        select.innerHTML = '<option value="">Select a book...</option>';
        availableBooks.forEach(book => {
          const option = document.createElement('option');
          option.value = book.id;
          option.textContent = `${book.title} by ${book.author} - â‚±${parseFloat(book.rental_price).toFixed(2)}/day`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Error loading books:', err);
        document.getElementById('bookSelect').innerHTML = '<option value="">Error loading books</option>';
      }
    }

    async function loadLibrarians() {
      try {
        const response = await authAxios({
          method: 'GET',
          url: 'https://prolens.ccs4thyear.com/api/librarians'
        });

        const librarians = response.data || [];
        const select = document.getElementById('librarianSelect');

        if (!librarians.length) {
          select.innerHTML = '<option value="">No librarians available</option>';
          return;
        }

        select.innerHTML = '<option value=\"\">Any available librarian</option>';
        librarians.forEach(lib => {
          const option = document.createElement('option');
          option.value = lib.id;
          option.textContent = `${lib.full_name} (@${lib.username})`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Error loading librarians:', err);
        document.getElementById('librarianSelect').innerHTML = '<option value=\"\">Error loading librarians</option>';
      }
    }

    document.getElementById('rentBookForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      const rentalData = {
        book_id: parseInt(formData.get('book_id')),
        rental_duration: parseInt(formData.get('rental_duration')),
        rental_date: formData.get('rental_date')
      };

      const librarianId = formData.get('librarian_id');
      if (librarianId) {
        rentalData.librarian_id = parseInt(librarianId);
      }

      try {
        await createRental(rentalData);
        alert('Rental request submitted successfully!');
        e.target.reset();
        document.getElementById('returnDate').value = '';
        loadAvailableBooks();
        loadLibrarians();
      } catch (err) {
        alert('Error submitting rental: ' + (err.response?.data?.message || err.message));
      }
    });

    loadAvailableBooks();
    loadLibrarians();

    const hamburger = document.getElementById('hamburger');
    const navMenu = document.getElementById('nav-menu');
    if (hamburger && navMenu) {
      hamburger.addEventListener('click', () => {
        hamburger.classList.toggle('active');
        navMenu.classList.toggle('active');
      });
    }
  </script>
</body>
</html>

